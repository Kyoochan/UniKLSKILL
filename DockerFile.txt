FROM php:8.2-cli

# ========================
# System dependencies
# ========================
RUN apt-get update && apt-get install -y \
    git unzip curl \
    libpng-dev libonig-dev libxml2-dev libzip-dev \
    nodejs npm zip \
    && rm -rf /var/lib/apt/lists/*

# ========================
# PHP extensions
# ========================
RUN docker-php-ext-install \
    pdo_mysql mbstring exif pcntl bcmath gd zip

# ========================
# Working directory
# ========================
WORKDIR /app

# ========================
# Copy app files
# ========================
COPY . .

# ========================
# Install Composer
# ========================
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

RUN composer install --no-dev --optimize-autoloader --no-interaction

# ========================
# Build frontend assets
# ========================
RUN npm install && npm run build

# ========================
# Permissions
# ========================
RUN chmod -R 775 storage bootstrap/cache

# ========================
# Expose Railway port
# ========================
EXPOSE 8080

# ========================
# Start Laravel (NO Apache)
# ========================
CMD php -S 0.0.0.0:8080 -t public
