# ========================
# Stage 1: Node build (Tailwind + Vite)
# ========================
FROM node:20 AS node-builder

WORKDIR /app

# Copy package.json & lock first (better caching)
COPY package*.json ./

# Install Node dependencies
RUN npm ci

# Copy the rest of the app
COPY . .

# Build production assets (Tailwind + Vite)
RUN npm run build


# ========================
# Stage 2: PHP production image
# ========================
FROM php:8.2-cli

# ------------------------
# System dependencies
# ------------------------
RUN apt-get update && apt-get install -y \
    git unzip curl libpng-dev libonig-dev libxml2-dev libzip-dev zip \
    && rm -rf /var/lib/apt/lists/*

# ------------------------
# PHP extensions
# ------------------------
RUN docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd zip

# ------------------------
# Working directory
# ------------------------
WORKDIR /app

# ------------------------
# Copy Laravel app files
# ------------------------
COPY . .

# ------------------------
# Copy compiled assets from Node stage
# ------------------------
COPY --from=node-builder /app/public/build ./public/build

# ------------------------
# Install Composer
# ------------------------
COPY --from=composer:2 /usr/bin/composer /usr/bin/composer
RUN composer install --no-dev --optimize-autoloader --no-interaction

# ------------------------
# Permissions
# ------------------------
RUN chmod -R 775 storage bootstrap/cache \
    && chown -R www-data:www-data storage bootstrap/cache

# ------------------------
# Expose port
# ------------------------
EXPOSE 8080

# ------------------------
# Start Laravel server
# ------------------------
CMD php -S 0.0.0.0:8080 -t public
